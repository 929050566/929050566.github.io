<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">


<meta name="baidu-site-verification" content="mrSaJ4uJ8z">
<meta name="baidu-site-verification" content="owvyVcpZUx">
<meta name="google-site-verification" content="oy_lPgdf5gdUpaAESj7zkW7PjVrWce205YLBq4hgA5w">
<meta name="google-site-verification" content="iTtZMlLeGbbsRl-GNQFoHAhSbTfdSN_ZNfBotJgueV0">

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
  <style>
      .pace .pace-progress {
          background: #1E92FB; /*进度条颜色*/
          height: 3px;
      }
      .pace .pace-progress-inner {
           box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
      }
      .pace .pace-activity {
          border-top-color: #1E92FB;    /*上边框颜色*/
          border-left-color: #1E92FB;    /*左边框颜色*/
      }
  </style>










<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="google-site-verification" content="true">














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/favicon.ico?v=5.1.4" color="#222">





  <meta name="keywords" content="MySQL,">










<meta name="description" content="原理 MySQL的逻辑分层MySQL的逻辑分层为四层或三层，我在知乎上找到的材料如下图：MySQL是关系数据库，关系数据库，顾名思义，是建立在关系模型基础上的数据库，我们现实世界中的各种实体以及实体之间的各种联系一般可用关系模型来表示。经过数十年的发展，关系数据库在理论和工业实践中都已经发展到很成熟的地步，可以说，目前的绝大部分应用，使用MySQL都有成熟的解决方案。 数据库的架构一般可以分为应用">
<meta name="keywords" content="MySQL">
<meta property="og:type" content="article">
<meta property="og:title" content="[MySQL]--SQL优化">
<meta property="og:url" content="https://a929050566.coding.me/2019/03/01/MySQL-SQL优化/index.html">
<meta property="og:site_name" content="个人博客">
<meta property="og:description" content="原理 MySQL的逻辑分层MySQL的逻辑分层为四层或三层，我在知乎上找到的材料如下图：MySQL是关系数据库，关系数据库，顾名思义，是建立在关系模型基础上的数据库，我们现实世界中的各种实体以及实体之间的各种联系一般可用关系模型来表示。经过数十年的发展，关系数据库在理论和工业实践中都已经发展到很成熟的地步，可以说，目前的绝大部分应用，使用MySQL都有成熟的解决方案。 数据库的架构一般可以分为应用">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://a929050566.coding.me/images/MySQL/逻辑分层.png">
<meta property="og:image" content="https://a929050566.coding.me/images/MySQL/逻辑分层3.png">
<meta property="og:image" content="https://a929050566.coding.me/images/MySQL/explain0.png">
<meta property="og:image" content="https://a929050566.coding.me/images/MySQL/explain1.png">
<meta property="og:image" content="https://a929050566.coding.me/images/MySQL/explain2.png">
<meta property="og:updated_time" content="2019-03-05T00:51:56.922Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[MySQL]--SQL优化">
<meta name="twitter:description" content="原理 MySQL的逻辑分层MySQL的逻辑分层为四层或三层，我在知乎上找到的材料如下图：MySQL是关系数据库，关系数据库，顾名思义，是建立在关系模型基础上的数据库，我们现实世界中的各种实体以及实体之间的各种联系一般可用关系模型来表示。经过数十年的发展，关系数据库在理论和工业实践中都已经发展到很成熟的地步，可以说，目前的绝大部分应用，使用MySQL都有成熟的解决方案。 数据库的架构一般可以分为应用">
<meta name="twitter:image" content="https://a929050566.coding.me/images/MySQL/逻辑分层.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://a929050566.coding.me/2019/03/01/MySQL-SQL优化/">





  <title>[MySQL]--SQL优化 | 个人博客</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">张豪</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-简历">
          <a href="/resume/index.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            简历
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://a929050566.coding.me/2019/03/01/MySQL-SQL优化/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张豪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar2.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">[MySQL]--SQL优化</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-01T19:34:44+08:00">
                2019-03-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/03/01/MySQL-SQL优化/" class="leancloud_visitors" data-flag-title="[MySQL]--SQL优化">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4,503字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  18分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p><hr></p>
<h2 id="MySQL的逻辑分层"><a href="#MySQL的逻辑分层" class="headerlink" title="MySQL的逻辑分层"></a>MySQL的逻辑分层</h2><p>MySQL的逻辑分层为四层或三层，我在知乎上找到的材料如下图：<br><img src="/images/MySQL/逻辑分层.png" alt=""><br>MySQL是关系数据库，关系数据库，顾名思义，是建立在关系模型基础上的数据库，我们现实世界中的各种实体以及实体之间的各种联系一般可用关系模型来表示。经过数十年的发展，关系数据库在理论和工业实践中都已经发展到很成熟的地步，可以说，目前的绝大部分应用，使用MySQL都有成熟的解决方案。</p>
<p>数据库的架构一般可以分为应用层,逻辑层,物理层，MySQL也可以这样理解.</p>
<p>对应于MySQL：</p>
<p><strong>应用层</strong>，负责和客户端,用户交互，需要和不同的客户端和中间服务器进行交互，建立连接，记住连接的状态，响应它们的请求，返回数据和控制信息（错误信息，状态码等）。</p>
<p><strong>逻辑层</strong>，负责具体的查询处理、事务管理、存储管理、恢复管理,以及其他的附加功能。查询处理器负责查询解析、执行，当接收到客户端的Sql查询，数据库就分配一个线程来处理它，由查询处理器生成执行计划，交由计划执行器来执行，执行器的部分操作还需要访问更底层的事务存储管理器操作数据，事务、存储管理器主要负责我们的事务管理、并发控制、存储管理，由我们的事务管理器来确保“ACID”特性，由锁管理器来控制我们的并发，由日志管理器来确保我们的数据持久化，存储管理器一般还包括一个bufer管理器，由它来确定磁盘和内存缓冲之间的数据传输。</p>
<p><strong>物理层</strong>，实际物理磁盘(存储)上的数据库文件.如我们的数据文件、日志文件等。</p>
<p>以下是MySQL官方文档的一个基础架构图，图中的Connectors可以理解为各种客户端端，应用服务，图中的Connection Pool 可以理解为应用层，负责连接、验证等功能，图中的Management Services &amp; Utilities,SQL Interface,Parse,Optimizer,Cache &amp; Buffers,Pluggable Storage Engines可以理解为我们数据库的大脑——逻辑层。图最下方的Files&amp; Logs可以理解为物理层。</p>
<p><strong>实际也可以将MySQL逻辑分为三层</strong>，如下图:<br><img src="/images/MySQL/逻辑分层3.png" alt=""></p>
<ol>
<li>连接层：提供与客户连接的服务</li>
<li>服务层：1.提供各种用户使用的接口 2.<strong>提供SQL优化器（MySQL Query Optimizer）</strong></li>
<li>引擎层：数据库引擎</li>
<li>存储层：数据存储</li>
</ol>
<p><strong>其中SQL的优化和SQL优化器有很大的联系</strong></p>
<p><hr></p>
<h2 id="数据库引擎"><a href="#数据库引擎" class="headerlink" title="数据库引擎"></a>数据库引擎</h2><p><strong>InnoDB</strong> ：如果要提供提交、回滚、崩溃恢复能力的事务安全（ACID兼容）能力，并要求实现并发控制，InnoDB是一个好的选择</p>
<p><strong>InnoDB</strong> 和 <strong>MyISAM</strong>之间的区别： </p>
<ol>
<li><p>InnoDB支持事物，而MyISAM不支持事物</p>
</li>
<li><p>InnoDB支持行级锁，而MyISAM支持表级锁</p>
</li>
<li><p>InnoDB支持MVCC, 而MyISAM不支持</p>
</li>
<li><p>InnoDB支持外键，而MyISAM不支持</p>
</li>
<li><p>InnoDB不支持全文索引，而MyISAM支持。（X)</p>
</li>
</ol>
<p><strong>MyISAM</strong>：如果数据表主要用来插入和查询记录，则MyISAM（但是不支持事务）引擎能提供较高的处理效率</p>
<p><strong>Memory</strong>：如果只是临时存放数据，数据量不大，并且不需要较高的数据安全性，可以选择将数据保存在内存中的Memory引擎，MySQL中使用该引擎作为临时表，存放查询的中间结果。数据的处理速度很快但是安全性不高。<br><strong><br>Archive</strong>：如果只有INSERT和SELECT操作，可以选择Archive，Archive支持高并发的插入操作，但是本身不是事务安全的。Archive非常适合存储归档数据，如记录日志信息可以使用Archive</p>
<p>更详细的引擎介绍大家请自行参照<a href="https://blog.csdn.net/zgrgfr/article/details/74455547" target="_blank" rel="noopener">Mysql 存储引擎的区别和比较</a>。使用哪一种引擎需要灵活选择，一个数据库中多个表可以使用不同引擎以满足各种性能和实际需求，使用合适的存储引擎，将会提高整个数据库的性能。</p>
<p><hr></p>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p><strong>分类</strong>：</p>
<ol>
<li><strong>主键索引</strong>：  不能重复，id不能是null。</li>
<li><strong>唯一索引</strong>  ：不能重复，id可以是null。</li>
<li><strong>单值索引</strong>  ：单列， age ;一个表可以多个单值索引,name。</li>
<li><strong>复合索引</strong>  ：多个列构成的索引（相当于 二级目录 ：  z: zhao）  (name,age)   (a,b,c,d,…,n)</li>
</ol>
<p><strong>创建索引</strong>：</p>
<blockquote>
<p><strong>方式一： create 索引类型  索引名  on 表(字段)</strong></p>
<blockquote>
<p>单值：<br>create index   dept_index on  tb(dept);<br>唯一：<br>create unique index  name_index on tb(name) ;<br>复合索引<br>create index dept_name_index on tb(dept,name);</p>
</blockquote>
<p><strong>方式二：alter table 表名 索引类型  索引名（字段）</strong></p>
<blockquote>
<p>单值：<br>alter table tb add index dept_index(dept) ;<br>唯一：<br>alter table tb add unique index name_index(name);<br>复合索引<br>alter table tb add index dept_name_index(dept,name);</p>
</blockquote>
</blockquote>
<p><strong>注意：如果一个字段是primary key，则改字段默认就是 主键索引    </strong></p>
<p><strong>删除索引：</strong></p>
<blockquote>
<p>drop index 索引名 on 表名 ;<br>drop index name_index on tb ;</p>
</blockquote>
<p><strong>查看索引:</strong></p>
<blockquote>
<p>show index from 表名;<br>show index from 表名 \G;</p>
</blockquote>
<p><strong>索引相当于书的目录， 索引是帮助MYSQL高效获取数据的数据结构。索引是数据结构（B+Tree）。</strong></p>
<p><strong>索引的弊端：</strong></p>
<ol>
<li>索引本身很大，可以存放在内存/硬盘（通常为硬盘）</li>
<li>索引不是所有情况均适用：a.少量数据 b.频繁更新字段 c.最少使用的字段</li>
<li>索引会减低增删改的效率</li>
</ol>
<p><strong>索引的优势：</strong></p>
<ol>
<li>提高查询效率（降低IO使用率）</li>
<li>降低CPU使用率（…order by age desc,因为 B树索引 本身就是一个 好排序的结构，因此在排序时  可以直接使用）</li>
</ol>
<p><hr></p>
<h1 id="SQL优化"><a href="#SQL优化" class="headerlink" title="SQL优化"></a>SQL优化</h1><p>SQL语句的性能损耗大主要有一下原因：原因：性能低、执行时间太长、等待时间太长、SQL语句欠佳（连接查询）、索引失效、服务器参数设置不合理（缓冲、线程数）。</p>
<p><strong>而SQL的优化，主要是在优化索引。</strong></p>
<p><hr></p>
<h2 id="SQL解析顺序"><a href="#SQL解析顺序" class="headerlink" title="SQL解析顺序"></a>SQL解析顺序</h2><p>SQL实际的解析过程为：</p>
<ol>
<li>FROM <left_table></left_table></li>
<li>ON <join_condition></join_condition></li>
<li><join_type> JOIN <right_table></right_table></join_type></li>
<li>WHERE <where_condition></where_condition></li>
<li>GROUP BY <group_by_list></group_by_list></li>
<li>HAVING <having_condition></having_condition></li>
<li>SELECT </li>
<li>DISTINCT <select_list></select_list></li>
<li>ORDER BY <order_by_condition></order_by_condition></li>
<li>LIMIT <limit_number></limit_number></li>
</ol>
<p>一看还是很自然和谐的，从哪里获取，不断的过滤条件，要选择一样或不一样的，排好序，那才知道要取前几条呢。</p>
<p>详情可以参考：<a href="https://www.cnblogs.com/annsshadow/p/5037667.html" target="_blank" rel="noopener">SQL解析顺序</a></p>
<p><hr></p>
<h2 id="SQL性能问题"><a href="#SQL性能问题" class="headerlink" title="SQL性能问题"></a>SQL性能问题</h2><ol>
<li>分析SQL的执行计划  : <strong>explain</strong>   ，可以模拟SQL优化器执行SQL语句，从而让开发人员 知道自己编写的SQL状况</li>
<li>MySQL服务层的查询优化其会干扰我们的优化</li>
</ol>
<p>查询执行计划：  explain +SQL语句</p>
<blockquote>
<p>explain  select  * from tb ;</p>
</blockquote>
<p>例如：<br><img src="/images/MySQL/explain0.png" alt=""></p>
<p>id : 编号<br>select_type ：查询类型<br>table ：表<br>type   ：类型<br>possible_keys ：预测用到的索引<br>key  ：实际使用的索引<br>key_len ：实际使用索引的长度<br>ref  :表之间的引用<br>rows ：查询到的数据量<br>Extra     :额外的信息</p>
<p><hr></p>
<h3 id="插入测试数据"><a href="#插入测试数据" class="headerlink" title="插入测试数据"></a>插入测试数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">create table course</span><br><span class="line">(</span><br><span class="line">cid int(3),</span><br><span class="line">cname varchar(20),</span><br><span class="line">tid int(3)</span><br><span class="line">);</span><br><span class="line">create table teacher</span><br><span class="line">(</span><br><span class="line">tid int(3),</span><br><span class="line">tname varchar(20),</span><br><span class="line">tcid int(3)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">create table teacherCard</span><br><span class="line">(</span><br><span class="line">tcid int(3),</span><br><span class="line">tcdesc varchar(200)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">insert into course values(1,&apos;java&apos;,1);</span><br><span class="line">insert into course values(2,&apos;html&apos;,1);</span><br><span class="line">insert into course values(3,&apos;sql&apos;,2);</span><br><span class="line">insert into course values(4,&apos;web&apos;,3);</span><br><span class="line"></span><br><span class="line">insert into teacher values(1,&apos;tz&apos;,1);</span><br><span class="line">insert into teacher values(2,&apos;tw&apos;,2);</span><br><span class="line">insert into teacher values(3,&apos;tl&apos;,3);</span><br><span class="line"></span><br><span class="line">insert into teacherCard values(1,&apos;tzdesc&apos;) ;</span><br><span class="line">insert into teacherCard values(2,&apos;twdesc&apos;) ;</span><br><span class="line">insert into teacherCard values(3,&apos;tldesc&apos;) ;</span><br></pre></td></tr></table></figure>
<p><hr></p>
<h3 id="id"><a href="#id" class="headerlink" title="id"></a>id</h3><p>如果id值相同：从上往下 顺序执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain select t.* from course c,teacher t,teacherCard tc  where c.cid = t.tid and t.tid=tc.tcid and (t.tid = 2 or tc.tcid = 3);</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/MySQL/explain1.png" alt=""></p>
<p>如果id值不同:id值越大越优先；id值相同，从上往下 顺序执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">explain select tc.tcdesc from teacherCard tc where tc.tcid = </span><br><span class="line">(select t.tcid from teacher t where  t.tid =  </span><br><span class="line">	(select c.tid from course c where c.cname = &apos;sql&apos;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/MySQL/explain2.png" alt=""></p>
<p><hr></p>
<h3 id="select-type-查询类型"><a href="#select-type-查询类型" class="headerlink" title="select_type:查询类型"></a>select_type:查询类型</h3><p>PRIMARY:包含子查询SQL中的 主查询 （最外层）<br>SUBQUERY：包含子查询SQL中的 子查询 （非最外层）<br>simple:简单查询（不包含子查询、union）<br>derived:衍生查询(使用到了临时表)</p>
<ol>
<li><p>在from子查询中只有一张表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain select  cr.cname from ( select * from course where tid in (1,2) ) cr ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在from子查询中， 如果有table1 union table2 ，则table1 就是derived,table2就是union</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain select  cr.cname from ( select * from course where tid = 1  union select * from course where tid = 2 ) cr ;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>union:上例<br>union result :告知开发人员，那些表之间存在union查询</p>
<p><hr></p>
<h3 id="type-索引类型、类型"><a href="#type-索引类型、类型" class="headerlink" title="type:索引类型、类型"></a>type:索引类型、类型</h3><p>值：system&gt;const&gt;eq_ref&gt;ref&gt;range&gt;index&gt;all，<strong>要对type进行优化的前提：有索引</strong></p>
<p>其中：system,const只是理想情况；实际能达到 ref&gt;range</p>
<p><strong>system</strong>（忽略）: 只有一条数据的系统表 ；或 衍生表只有一条数据的主查询。</p>
<p><strong>const</strong>:仅仅能查到一条数据的SQL ,用于Primary key 或unique索引（类型 与索引类型有关）。</p>
<p><strong>eq_ref</strong>:唯一性索引：对于每个索引键的查询，返回匹配唯一行数据（有且只有1个，不能多 、不能0）。</p>
<p><strong>ref</strong>：非唯一性索引，对于每个索引键的查询，返回匹配的所有行（0，多）。</p>
<p><strong>range</strong>：检索指定范围的行 ,where后面是一个范围查询(between,&gt; &lt; &gt;=,特殊:in有时候会失效 ，从而转为 无索引all)。</p>
<p><strong>index</strong>：查询全部索引中数据。</p>
<p><strong>all</strong>：查询全部表中的数据。</p>
<p><strong>总结</strong>:</p>
<ol>
<li>system/const: 结果只有一条数据</li>
<li>eq_ref:结果多条；但是每条数据是唯一的 ；</li>
<li>ref：结果多条；但是每条数据是是0或多条 ；</li>
</ol>
<p><hr></p>
<h3 id="possible-keys"><a href="#possible-keys" class="headerlink" title="possible_keys"></a>possible_keys</h3><p>可能用到的索引，是一种预测，不准。 </p>
<p><hr></p>
<h3 id="key"><a href="#key" class="headerlink" title="key"></a>key</h3><p>实际使用到的索引</p>
<p><hr></p>
<h3 id="key-len"><a href="#key-len" class="headerlink" title="key_len"></a>key_len</h3><p>索引的长度。<strong>是字节长度</strong><br>作用：用于判断复合索引是否被完全使用（a,b,c）。<br><strong>utf8：1个字符站3个字节。</strong><br><strong>GBK：1个字符站2个字节。</strong><br><strong>latin:1个字符1个字节</strong></p>
<p>如果索引字段可以为Null,则会使用1个字节用于标识。<br>用2个字节，标识可变长度。</p>
<p><hr></p>
<h3 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h3><p>注意与type中的ref值区分。<br><strong>作用： 指明当前表所参照的字段。</strong></p>
<p><hr></p>
<h3 id="rows"><a href="#rows" class="headerlink" title="rows"></a>rows</h3><p>被索引优化查询的数据个数 (实际通过索引而查询到的数据个数)。</p>
<p><hr></p>
<h3 id="Extra"><a href="#Extra" class="headerlink" title="Extra"></a>Extra</h3><ol>
<li>using filesort ： 性能消耗大；需要“额外”的一次排序（查询）  。常见于 order by 语句中。</li>
<li>using temporary:性能损耗大 ，用到了临时表。一般出现在group by 语句中。</li>
<li>using index :性能提升; 索引覆盖（覆盖索引）。原因：不读取原文件，只从索引文件中获取数据 （不需要回表查询）只要使用到的列 全部都在索引中，就是索引覆盖using index。</li>
<li>using where （需要回表查询）。</li>
<li>impossible where ： where子句永远为false</li>
<li>Using join buffer:Mysql引擎使用了 连接缓存。</li>
</ol>
<p><hr></p>
<h2 id="优化原则"><a href="#优化原则" class="headerlink" title="优化原则"></a>优化原则</h2><p>优化主要是通过合理添加索引。</p>
<p>查询语句的优化，将能筛选更多数据（选择更少数据）的条件语句放在前面，并且索引建立在经常使用的字段上。</p>
<p>避免索引失效也是优化的一部分，为了避免索引失效，需要尽量遵循下面几条规则：<br><strong>1.复合索引，不要跨列或者无序使用（用最佳左前缀匹配）</strong><br>例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter table test add index  idx_a1_a2_a3(a1,a2,a3); // 添加索引</span><br><span class="line">select a1 from test where a1=&apos;&apos; and a2=&apos;&apos; and a3=&apos;&apos;;</span><br></pre></td></tr></table></figure></p>
<p><strong>2.不要在索引上进行任何操作（计算、函数、类型转换），否则索引失效。</strong><br>例如:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from test where id*3 = 3;</span><br></pre></td></tr></table></figure></p>
<p><strong>3.复合索引不能使用不等于（!=  &lt;&gt;）或is null (is not null)，否则自身以及右侧所有全部失效。</strong></p>
<p><strong>4.尽量使用索引覆盖（using index）。</strong></p>
<p><strong>5.like尽量以“常量”开头，不要以’%’开头，否则索引失效。</strong></p>
<p><strong>6.尽量不要使用类型转换（显示、隐式），否则索引失效。</strong></p>
<p><strong>7.尽量不要使用or，否则索引失效。</strong><br>OR会引起索引失效的说法是这样来的：</p>
<blockquote>
<p>如果是这样一个查询</p>
<blockquote>
<p>SELECT * FROM TB WHERE A=1 AND B&gt;2 AND C&lt;3 AND D IN (4,5,6)</p>
</blockquote>
<p>并且在TB表上有这样一个索引：CREATE INDEX INX_TB_ABCD ON TB (A,B,C,D)<br>那么这个查询可以用到这个索引</p>
<p>如果同样是这个索引，查询换成</p>
<blockquote>
<p>SELECT * FROM TB_ WHERE A=1 OR B&gt;2 OR C&lt;3 OR D IN (4,5,6)  </p>
</blockquote>
<p>那么这个查询就用不到上面那个索引，因为结果集是几个条件的并集，最多只能在查找A=1的数据时用索引，其它几个条件都需要表扫描，那优化器就会选择直接走一遍表扫描，所以索引就失效了。</p>
<p>那么像第二个查询这样的应该怎么建索引呢，答案就是四个列上各建一个索引，或者只在选择性最高的列上建索引，比如A=1的数据量很少，就在A上建，如果D是4，5，6的数据很少，就在D上建，这样优化器就会选择先走索引查找，再对找出的结果集进行筛选，扫描数就会大幅减少。</p>
</blockquote>
<p><hr></p>
<h2 id="其他的优化方法"><a href="#其他的优化方法" class="headerlink" title="其他的优化方法"></a>其他的优化方法</h2><p><hr></p>
<h3 id="exist和in"><a href="#exist和in" class="headerlink" title="exist和in"></a>exist和in</h3><p>exist用法:<br>select ..from table where exist (子查询);<br>例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select tname from teacher where exists (select * from teacher) ; </span><br><span class="line">	--等价于select tname from teacher</span><br></pre></td></tr></table></figure></p>
<p>in用法:<br>select ..from table where 字段 in  (子查询) ;</p>
<p>如果主查询的数据集大，则使用In ,效率高。<br>如果子查询的数据集大，则使用exist,效率高。    </p>
<p><hr></p>
<h3 id="order-by优化"><a href="#order-by优化" class="headerlink" title="order by优化"></a>order by优化</h3><p><strong>using filesort 有两种算法：双路排序、单路排序 （根据IO的次数）—IO较消耗性能</strong><br><strong>MySQL4.1之前 默认使用 双路排序</strong>；双路：扫描2次磁盘（1：从磁盘读取排序字段 ,对排序字段进行排序（在buffer中进行的排序）   2：扫描其他字段 ）<br><strong>MySQL4.1之后 默认使用 单路排序</strong> ：只读取一次（全部字段），在buffer中进行排序。但种单路排序 会有一定的隐患 （不一定真的是“单路|1次IO”，有可能多次IO）。原因：如果数据量特别大，则无法 将所有字段的数据 一次性读取完毕，因此 会进行“分片读取、多次读取”。<br><strong>注意：单路排序 比双路排序 会占用更多的buffer。</strong><br>单路排序在使用时，如果数据大，可以考虑调大buffer的容量大小：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set max_length_for_sort_data = 1024  单位byte</span><br></pre></td></tr></table></figure></p>
<p>如果max_length_for_sort_data值太低，则mysql会自动从 单路-&gt;双路   （太低：需要排序的列的总大小超过了max_length_for_sort_data定义的字节数）</p>
<p><strong>提高order by查询的策略</strong>:<br>a.选择使用单路、双路 ；调整buffer的容量大小；<br>b.避免select <em> … （程序还需要计算</em>是什么）<br>c.复合索引 不要跨列使用 ，避免using filesort<br>d.保证全部的排序字段 排序的一致性（都是升序 或 降序）</p>
<p><hr></p>
<h1 id="SQL排查"><a href="#SQL排查" class="headerlink" title="SQL排查"></a>SQL排查</h1><h2 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h2><p>MySQL提供的一种日志记录，用于记录MySQL种响应时间超过阀值的SQL语句（long_query_time，默认10秒）<br><strong>慢查询日志默认是关闭的,建议开发调优是打开，而最终部署时关闭。</strong></p>
<p><strong>检查是否开启了 慢查询日志：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &apos;%slow_query_log%&apos; ;</span><br></pre></td></tr></table></figure></p>
<p><strong>临时开启：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global slow_query_log = 1 ;  --在内存种开启</span><br></pre></td></tr></table></figure></p>
<p><strong>永久开启：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/my.cnf 中追加配置：</span><br><span class="line">vi /etc/my.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">slow_query_log=1</span><br><span class="line">slow_query_log_file=/var/lib/mysql/localhost-slow.log</span><br></pre></td></tr></table></figure></p>
<p><strong>慢查询阀值：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &apos;%long_query_time%&apos; ;</span><br></pre></td></tr></table></figure></p>
<p><strong>临时设置阀值：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global long_query_time = 5 ; --设置完毕后，重新登陆后起效 （不需要重启服务）</span><br></pre></td></tr></table></figure></p>
<p><strong>永久设置阀值：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/my.cnf 中追加配置：</span><br><span class="line">vi /etc/my.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">long_query_time=3</span><br></pre></td></tr></table></figure></p>
<p><strong>查询超过阀值的SQL：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show global status like &apos;%slow_queries%&apos; ;</span><br></pre></td></tr></table></figure></p>
<h2 id="mysqldumpslow"><a href="#mysqldumpslow" class="headerlink" title="mysqldumpslow"></a>mysqldumpslow</h2><p>mysqldumpslow —help可显示其参数的使用<br>经常使用的参数：</p>
<p>-s    是order的顺序</p>
<p>al  平均锁定时间</p>
<p>ar  平均返回记录时间</p>
<p>at  平均查询时间（默认）</p>
<p>c   计数</p>
<p>l   锁定时间</p>
<p>r   返回记录</p>
<p>t   查询时间</p>
<p>-t 是top n的意思，即为返回前面多少条的数据</p>
<p>-g 后边可以写一个正则匹配模式，大小写不敏感的</p>
<p>例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldumpslow -t 10 -s t -g &quot;left join&quot; host-slow.log</span><br></pre></td></tr></table></figure></p>
<p>使用mysqldumpslow的分析结果不会显示具体完整的sql语句，说明：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM sms_send WHERE service_id=10 GROUP BY content LIMIT 0, 1000;</span><br></pre></td></tr></table></figure></p>
<p>mysqldumpslow显示的结果会是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Count: 1  Time=1.91s (1s)  Lock=0.00s (0s)  Rows=1000.0 (1000), vgos_dba[vgos_dba]@[10.130.229.196]</span><br><span class="line">SELECT * FROM sms_send WHERE service_id=N GROUP BY content LIMIT N, N;</span><br></pre></td></tr></table></figure></p>
<p><strong>Count</strong>:会告诉我们这种类型的语句执行了几次<br><strong>Time</strong>:会告诉我们这种类型的语句执行的最大时间<br><strong>Lock</strong>:等待锁时间<br><strong>Rows</strong>:返回的行数</p>
<h2 id="SQL诊断"><a href="#SQL诊断" class="headerlink" title="SQL诊断"></a>SQL诊断</h2><p><strong>profiles:</strong></p>
<p>查看是否开启：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &apos;%profiling%&apos;;</span><br></pre></td></tr></table></figure></p>
<p>开启:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set profiling = on ;</span><br></pre></td></tr></table></figure></p>
<p>查看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show profiles  ：会记录所有profiling打开之后的  全部SQL查询语句所花费的时间。缺点：不够精确，只能看到 总共消费的时间，不能看到各个硬件消费的时间（cpu  io ）</span><br></pre></td></tr></table></figure></p>
<p><strong>精确分析</strong><br>查看上一步查询的Query_Id<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show profile all for query + 上一步查询的Query_Id</span><br></pre></td></tr></table></figure></p>
<p>show profile cpu,block io for query + 上一步查询的Query_Id</p>
<h2 id="全局查询日志"><a href="#全局查询日志" class="headerlink" title="全局查询日志"></a>全局查询日志</h2><p><strong>记录开启之后会记录全部SQL语句。</strong><br>注意：这次全局的记录操作，仅仅在调优、开发过程中打开即可，在最终的部署实施时一定关闭。</p>
<p>查看是否开启：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &apos;%general_log%&apos;;</span><br></pre></td></tr></table></figure></p>
<p>执行的所有SQL记录在表中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set global general_log = 1 ;--开启全局日志</span><br><span class="line">set global log_output=&apos;table&apos; ; --设置 将全部的SQL 记录在表中</span><br></pre></td></tr></table></figure></p>
<p>执行的所有SQL记录在文件中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set global log_output=&apos;file&apos; ;</span><br><span class="line">set global general_log = on ;</span><br><span class="line">set global general_log_file=&apos;/tmp/general.log&apos; ;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    
    

    <!--自定义-->
    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
      
    </div>
    <!--自定义-->
    
    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MySQL/" rel="tag"># MySQL</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/02/28/mysql-锁机制/" rel="next" title="[MySQL]--锁机制">
                <i class="fa fa-chevron-left"></i> [MySQL]--锁机制
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/08/MySQL-主从同步/" rel="prev" title="[MySQL]--主从同步">
                [MySQL]--主从同步 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MTUyMC8xODA2Nw"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar2.png" alt="张豪">
            
              <p class="site-author-name" itemprop="name">张豪</p>
              <p class="site-description motion-element" itemprop="description">纵有疾风起，人生不言弃。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">35</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#原理"><span class="nav-number">1.</span> <span class="nav-text">原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL的逻辑分层"><span class="nav-number">1.1.</span> <span class="nav-text">MySQL的逻辑分层</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据库引擎"><span class="nav-number">1.2.</span> <span class="nav-text">数据库引擎</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#索引"><span class="nav-number">1.3.</span> <span class="nav-text">索引</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SQL优化"><span class="nav-number">2.</span> <span class="nav-text">SQL优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL解析顺序"><span class="nav-number">2.1.</span> <span class="nav-text">SQL解析顺序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL性能问题"><span class="nav-number">2.2.</span> <span class="nav-text">SQL性能问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#插入测试数据"><span class="nav-number">2.2.1.</span> <span class="nav-text">插入测试数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#id"><span class="nav-number">2.2.2.</span> <span class="nav-text">id</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#select-type-查询类型"><span class="nav-number">2.2.3.</span> <span class="nav-text">select_type:查询类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#type-索引类型、类型"><span class="nav-number">2.2.4.</span> <span class="nav-text">type:索引类型、类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#possible-keys"><span class="nav-number">2.2.5.</span> <span class="nav-text">possible_keys</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#key"><span class="nav-number">2.2.6.</span> <span class="nav-text">key</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#key-len"><span class="nav-number">2.2.7.</span> <span class="nav-text">key_len</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ref"><span class="nav-number">2.2.8.</span> <span class="nav-text">ref</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rows"><span class="nav-number">2.2.9.</span> <span class="nav-text">rows</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Extra"><span class="nav-number">2.2.10.</span> <span class="nav-text">Extra</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优化原则"><span class="nav-number">2.3.</span> <span class="nav-text">优化原则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他的优化方法"><span class="nav-number">2.4.</span> <span class="nav-text">其他的优化方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#exist和in"><span class="nav-number">2.4.1.</span> <span class="nav-text">exist和in</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#order-by优化"><span class="nav-number">2.4.2.</span> <span class="nav-text">order by优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SQL排查"><span class="nav-number">3.</span> <span class="nav-text">SQL排查</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#慢查询日志"><span class="nav-number">3.1.</span> <span class="nav-text">慢查询日志</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mysqldumpslow"><span class="nav-number">3.2.</span> <span class="nav-text">mysqldumpslow</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL诊断"><span class="nav-number">3.3.</span> <span class="nav-text">SQL诊断</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#全局查询日志"><span class="nav-number">3.4.</span> <span class="nav-text">全局查询日志</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张豪</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">82.4k</span>
  
</div>

<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>




  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>

-->






<script>
(function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("Ao8ulWHVQL8MoXaYC6Vdx83D-gzGzoHsz", "DOisvJRBttDNBED13TYDm3Gv");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
